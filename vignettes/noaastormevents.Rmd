---
title: "Overview of noaastormevents"
author: "Brooke Anderson, Ziyu Chen"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Overview of noaastormevents}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r echo = FALSE}
not_cran <- Sys.getenv("NOT_CRAN") == "blah"
print(not_cran)
if (!not_cran) {
   knitr::opts_chunk$set(eval = FALSE)
    msg <- paste("Note: Examples in this vignette are set to not run on CRAN. If you would",
                 "like to build this vignette locally, you can do so by first setting the",
                 "environmental variable 'NOT_CRAN' to 'true' on your computer and then ",
                 "rebuilding the vignette.")
    msg <- paste(strwrap(msg), collapse="\n")
    message(msg)
}
```

```{r, echo = FALSE, message=FALSE, warning=FALSE}
library(noaastormevents)
```

## Description of package

This package can be used to explore and map data from [NOAA's Storm Events Database](https://www.ncdc.noaa.gov/stormevents/). This storm event database ... [description]. It has aggregated storm event lisings for [tornados, ...] since [year] and for additional event types (e.g., [...]) since ... . This database has been used either alone or in conjunction with other data for a number of scientific studies (e.g., [...]). It is available for downloading at https://www.ncdc.noaa.gov/stormevents/ftp.jsp, with three files (one with event details, one with fatality details, and with with location details) available per year. 

While the online database does not have a structured API, this package uses regular expressions to search the listings of available files to identify the filename for a queried year and download that year's data to a user's R session. The package functions then filter the downloaded storm event listings based to the dates, locations, event types, and other search limitations specified by the user. In particular, this package can be used to identify storm event listings that were close in location and time to Atlantic basin tropical storm tracks. 

Several types of events can be queried and mapped with this package: 

- **Storm events:** (package functions `find_events` and `map_events`)
- **Direct deaths:** (package functions `find_direct_deaths` and `map_direct_deaths`)
- **Direct injuries:** (package functions `find_direct_injuries` and `map_direct_injuries`)
- **Indirect deaths:** (package functions `find_indirect_deaths` and `map_indirect_deaths`)
- **Indirect injuries:** (package functions `find_indirect_injuries` and `map_indirect_injuries`)
- **Property damage:** (package functions `find_damage_property` and `map_damage_property`)
- **Crop damage:** (package functions `find_damage_crops` and `map_damage_crops`)

Some events are listed in the original database by forecast zone rather than county. For these observations, the package functions attempts to match the observation with the appropriate county. However, there are some events listed by forecast zone that cannot be matched to county, and so are excluded from results returned by this package. Further, there may be occasional errors in this matching, so we include a marker returned datasets indicating which events were listed by forecast zone rather than county, to allow further quality control checks by the user for his or her specific applications of the package. 

It is important for users to note that there are limitations to this storm events database. In particular, listings can be somewhat subjective. A lack of event listing in the database should not be considered definitive proof that storm conditions did not exist at a location at a certain time. Further, the database has changed over time in terms of which types of events are included. R users should review the Storm Event Database's documentation, which is available at [the database's website](https://www.ncdc.noaa.gov/stormevents/), to be sure they understand how to use and interpret event listings from the database. 

## Simple example

### Creating a storm events dataset

The package has two main types of functionalities. First, it has a number of functions (the `find_*` family of functions in the package) that can be used to create dataframes of event listings. These functions differ only in the type of event listing (storm events, direct deaths, property damage, etc.). Second, the package has a number of functions (the `map_*` family of functions) that can be used to map storm event listings; again, these functions differ only in the type of event listing they query.

For example, the `find_events` function will create a dataframe with all storm event listings within a specified time frame. For example, the following code creates a dataframe with all events from the NOAA Storm Events Database listed as beginning between September 14 and 18, 1999 (a time window relevant for Hurricane Floyd, which caused extensive damage, especially from flooding):

```{r}
sept_1999_events <- find_events(date_range = c("1999-09-14", "1999-09-18"))
head(sept_1999_events)
```

The code call returns a data frame with a subset of data from the Storm Events Database for 1999. Each event listing with a start data between September 14 and 18 is included. The data frame has the following columns: 

- `begin_date`: The date the event began
- `end_date`: The date the event ended
- `state_county_name`: The state and county in which the event occurred. If the event was listed by forecast zone, the county name included for this column is based on the most appropriate county to link to the given forecast zone. 
- `state`: The state in which the event occurred
- `cz_type`: Whether the event was listed by county or by forecast zone (Where possible, events that are listed by forecast zone are linked to the appropriate county FIPS code and therefore not excluded from this returned dataframe. However, this column is included to allow users to perform quality control on events listed by forecast zone (`CZ_TYPE` of "Z").)
- `type`: Event type (e.g., "Flood", "Lightning", "Tornado", "Wildfire"). See [the NOAA Storm Events documentation](https://www.ncdc.noaa.gov/stormevents/pd01016005curr.pdf) for definitions of these event types
- `fips`: Five-digit county (Federal Information Processing Standard) FIPS code. This code uniquely identifies each U.S. county.
- `source`: The source of the storm event listing (e.g., trained spotter, emergency manager, general public, law enforcement)

In some cases, a user may wish to identify all storm events listings that were close in time and place to a tropical storm. The `noaastormevents` package therefore alls users to search for events close in time and location to a tropical storm. To do this, the package draws on data and functions in the `hurricaneexposure` and `hurricaneexposuredata` packages (in development on GitHub) to match storm event listings against tropical storm "best tracks" data, which provides 6-hour observations of storm strength and location. 

Event listings are pulled for all events that occured within a five-day window of the day the storm was closest to each county and that were within a user-specified distance of the storm track. For example, to create a dataset with all event listings for counties within 300 kilometers (`dist_limit` option) of the path of Hurricane Floyd (`storm = "Floyd-1999"`) and for which the event began within a five-day window of the storm's closest approach, the user can run:

```{r}
floyd_events <- find_events(storm = "Floyd-1999", dist_limit = 300)
head(floyd_events)
```

Note that the storm ID includes a storm name ("Floyd") and year ("1999"). Both must be specified, as storm names are not retired until they are used for a very severe storm. This functionality will only work for storms included in the `hurricaneexposuredata` package. These currently include: 

```{r echo = FALSE, message = FALSE, warning = FALSE}
library(dplyr)
library(hurricaneexposuredata)
data("hurr_tracks")
hurr_tracks %>% 
  tidyr::separate(storm_id, c("storm", "year")) %>%
  dplyr::select(storm, year) %>%
  dplyr::distinct() %>%
  dplyr::group_by(year) %>% 
  dplyr::summarize(storms = paste(storm, collapse = ", ")) %>% 
  knitr::kable()
```

Once `find_events` has been used to create a dataset of storm event listings, the dataset can be explored. The user can do things like determine the number of events of each type that occurred near in time and location to a storm's track. For example, here is a summary of numbers of different types of events for Hurricane Floyd, created using `dplyr` tools:

```{r message = FALSE, warning = FALSE}
library(dplyr)
floyd_events %>%
  group_by(event_type) %>%
  summarize(n = n()) %>%
  arrange(desc(n)) %>%
  knitr::kable(col.names = c("Event type", "Number of events"),
               caption = "NOAA Storm Events within 200 km and within a 5-day window of Hurricane Floyd.")
  
```

Similarly, you could create a summary with the states in which the most events were listed and give the number and type of events in each of those counties:

```{r}
floyd_events %>%
  group_by(state, event_type) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  arrange(state, desc(n)) %>%
  mutate(event_type = paste0(event_type, " (", n, ")")) %>%
  group_by(state) %>%
  summarize(Total = sum(n),
            Events = paste(event_type, collapse = ", ")) %>%
  ungroup() %>%
  arrange(desc(Total)) %>%
  knitr::kable()
```


### Mapping storm events

The package has a number of functions for mapping storm event listings from this database. For example, the `map_events` function allows you to map all events in the database with a starting date within a specified range. It also has some options specific to tropical storm research, including mapping only events with tropical storm-related tags or only events that happened in counties within a certain distance of the track of a specific tropical storm. 
Here are some examples: 

Mapping all counties that had at least one event over a date range:

```{r fig.width = 6, fig.height = 5}
event_data <- find_events(date_range = c("1999-09-14", "1999-09-18"))
map_events(event_data)
```

Mapping any county with at least one event, not restricting to only the eastern half of the country:

```{r fig.width = 6, fig.height = 5}
floyd_events <- find_events(storm = "Floyd-1999", dist_limit = 300) 
floyd_events %>% 
  map_events(east_only = FALSE)
```

Mapping the number of events in each county within a certain date range:

```{r fig.width = 6, fig.height = 5}
floyd_events %>% 
  map_events(plot_type = "number of events")
```

Mapping the crop damage reported in each county within a certain date range:

```{r fig.width = 6, fig.height = 5}
floyd_events %>%   
  map_events(plot_type = "crop damage")
```

Mapping the property damage reported in each county within a certain date range:

```{r fig.width = 6, fig.height = 5}
floyd_events %>% 
  map_events(plot_type = "property damage")
```

Mapping the number of events, but only counting counties that were within 200 kilometers of the track of Hurricane Floyd in 1999, with the hurricane's track added to the plot:

```{r fig.width = 6, fig.height = 5}
floyd_events %>% 
  map_events(plot_type = "number of events", storm = "Floyd-1999", add_tracks = TRUE)
```

## Details of how the package works

### Linking forecast zones to counties

Some events are reported by forecast zone rather than county; these events are reported using "Z" for the "CZ_ZONE" variable in the original Storm Events Database data. Rather than dropping all of these events, the `noaastormevents` functions attempt to match each of these events to an appropriate U.S. county.

To match these events to counties, functions in `noaastormevents` attempt to match the "cz_name" and "state_name" for the event to a real county and state name for a U.S county. For forecast zone events, the "cz_name" will often include qualifiers describing the part of a county in which an event occurred (e.g., "eastern", "southwest", "lower", "central", "interior"). A number of these qualifiers are removed from "cz_name" before trying to match this name with a real county name. In rare cases, this cleaning might be removing part of a true county name, but in practice it seems that more county matches can be correctly identified by removing these potential qualifiers. The functions also remove forward slashes and anything that comes after them (e.g., "Albemarle / Charlottesville" is changed to "Albemarle"). 

For all events that are identified by county (`cz_type` is "C"), the "cz_fips" column gives the county's FIPS directly. Therefore, matching by county name is not required for these events, and they are therefore likely more reliably linked to a county that the events reported by forecast zone.

We include a column called `cz_type` in the final data returned by the `find_*` family of functions. This column takes the value "C" is the event was reported by county and "Z" if it was reported by forecast zone. Therefore, if a user decides to exclude all events listed by forecast zone, he or she can use this column to filter. In other cases, a user may wish to include these events, but perform additional quality control checks to correct any incorrect county matching in the storm events pulled for his or her specific application.

### Package interaction with the NOAA Storm Events website

The `noaastormevents` package pulls data posted online by the National Centers for Environmental Information (NCEI; formally, the National Climatic Data Center [NCDC]). The NCEI currently includes comma-separated files covering different elements of the Storm Events database, with separate files for each year, which are available [here](http://www1.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/). 

For each year, there are three file types: 

- `"details"`
- `"fatalities"`
- `"locations"`

The file names all follow a consistent format (anything in square brackets is replaced by its value in each file name): 

```
StormEvents_[file type]-ftp_v[version number]_d[storm year]_c[date file created].csv.gz
```

More details on these file naming conventions are available from NCEI through a [README file](http://www1.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/README).

Because these file names include the date the file was created, these file names can change with time, and we don't know *a priori* what the name of the file for each year will be. However, if we have a list of available file names, it is possible to determine which corresponds to which year, by matching the year of data you'd like to the year within the `_d[storm year]_` part of the file name. 

One function in the `noaastormevents` package, `find_file_name`, uses the `readHTMLTable` function from the `XML` package to read all the file names from the online repository of files and, from this list, identify the appropriate file for the year requested. For example, to determine the "details" file name for 1999, you can run: 

```{r}
find_file_name(year = 1999)
```

While the default is to find the name of the "details" file type for a year, you can also use the `file_type` argument to pull any of the three file types. For example, to find out the name of the "fatalities" file for 1999, you could run: 

```{r}
find_file_name(year = 1999, file_type = "fatalities")
```

Files are compressed using gzip compression. 
